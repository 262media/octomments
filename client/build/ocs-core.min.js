!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).Octomments=n()}(this,function(){"use strict";function c(e){return function(e){if(Array.isArray(e))return e}(e)||n(e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||n(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function n(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function u(){return!0===function(){var e="test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}()?localStorage:{setItem:function(){},getITem:function(){},removeItem:function(){}}}function s(e,n){n=n||window.location.href,e=e.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]".concat(e,"(=([^&#]*)|&|#|$)")).exec(n);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}function f(n){return["code","error","error_description","error_uri","t"].forEach(function(e){n=n.replace(new RegExp("[?&]".concat(e,"=[^&]+")),"")}),n}function p(e){return{id:e.id,url:e.html_url,author:{login:e.user.login,avatarUrl:e.user.avatar_url,url:e.user.html_url},body:e.body_html,createdAt:e.created_at,updatedAt:e.updated_at}}var l="ERROR",m="USER_LOADING",g="USER_NONE",d="USER_LOADED",t="COMMENTS_LOADING",w="COMMENTS_LOADED",h="COMMENT_SAVING",v="COMMENT_SAVED",E="OCTOMMENTS_USER",y=[l,t,w,h,m,g,d,v];function b(i,e){var c=i.notify,n=i.options,a=i.error,u=n.endpoints,s=n.number,f=n.github,l=!!u,m=new Error("Error getting comments for issue #".concat(s,".")),r=new Error("Issue #".concat(s," doesn't exists."));function d(e){console.error(e),a(m,2)}function h(t){return function(e,n){if(n)a(m,2);else if(e.ok)t(e);else{if(404===e.status)return a(r,1);t(e)}}}c(t),function r(e){var o=0<arguments.length&&void 0!==e?e:1,n="https://api.github.com/repos/".concat(f.owner,"/").concat(f.repo,"/issues/").concat(s,"/comments?page=").concat(o);fetch(n,{headers:i.getHeaders()}).then(h(function(e){if(!e.ok)return 401===e.status?(i.logout(!1),c(g),void r(o)):403===e.status?l?void fetch("".concat(u.issue,"?owner=").concat(f.owner,"&repo=").concat(f.repo,"&number=").concat(s)).then(h(function(e){e.ok?e.json().then(function(e){var n=e.issue.comments;i.data={comments:i.data.comments.concat(n),pagination:null},c(w,n,null)}).catch(function(e){console.error(e),a(new Error("Error parsing the API response"),3)}):a(m,2)})).catch(d):a(new Error("Rate limit exceeded."),4):a(m,2);var n=e.headers.get("Link"),t=null;n&&(t=function(e){var n=e.split(","),t={};for(var r in n){var o=n[r],i={};i.name=o.match(/rel=\"([^\"]*)/)[1],i.url=o.match(/<([^>]*)/)[1],i.page=parseInt(o.match(/page=(\d+).*$/)[1],10),t[i.name]=i}return t}(n)),e.json().then(function(e){var n=e.map(p);i.data={comments:i.data.comments.concat(n),pagination:t},c(w,n,t)}).catch(d)}))}(e)}function S(t,e){var r=t.notify,o=t.error,n=t.options,i=n.number,c=n.github,a=new Error("Adding a new comment failed.");r(h);var u,s="https://api.github.com/repos/".concat(c.owner,"/").concat(c.repo,"/issues/").concat(i,"/comments");function f(e){console.error(e),o(a,10)}fetch(s,{method:"POST",headers:t.getHeaders(),body:JSON.stringify({body:e})}).then((u=function(e){r(v,[p(e)])},function(e,n){return n?o(a,8):e.ok?void e.json().then(function(e){e?u(e):o(new Error("Parsing new-comment response failed."),10)}).catch(f):401===e.status?(t.logout(!1),r(g),o(new Error("Not authorized. Log in again."),9)):403===e.status?o(new Error("Rate limit exceeded."),4):o(a,8)})).catch(f)}function r(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.number)throw new Error("`options.number` is missing.");o.endpoints||(o.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"}),o.debug&&console.log("Octomments started with: ",JSON.stringify(o,null,2));var i={},t={user:null,data:{comments:[],pagination:null},options:o,LS:u(),error:function(e,n){t.notify(l,e,n)},notify:function(e){for(var n=arguments.length,t=new Array(1<n?n-1:0),r=1;r<n;r++)t[r-1]=arguments[r];o.debug&&console.log(e,t),i[e]&&i[e].forEach(function(e){return e.apply(void 0,t)})}};if(t.initUser=function(){return function(t){function r(){return history.replaceState({},document.title,f(location.href))}var o=t.notify,i=t.error,e=t.generateNewCommentURL(),n=t.LS.getItem(E);if(n)try{t.user=JSON.parse(n),o(d,t.user,!1)}catch(e){console.error(e),i(new Error("Corrupted data in local storage."),5)}else if(s("t")){var c=s("t");t.user={token:c},o(m),fetch("https://api.github.com/user",{headers:t.getHeaders()}).then(function(e,n){n||!e.ok?(n&&console.error(n),r(),i(new Error("Problem getting user's info."),6)):e.json().then(function(e){t.user={token:t.user.token,login:e.login,avatarUrl:e.avatar_url,url:e.html_url,name:e.name},r(),t.LS.setItem(E,JSON.stringify(t.user)),o(d,t.user,!0)}).catch(function(e){console.error(e),i(new Error("Problem parsing access token response."),7)})}).catch(function(e){console.error(e),i(new Error("Problem getting access token."),6)})}else o(g,e)}(t)},t.initComments=function(){return b(t)},t.logout=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];t.user=null,t.LS.removeItem(E),e&&location.reload()},t.add=function(e){if(!t.user)throw new Error("No user logged in.");S(t,e)},t.off=function(e){return delete i[e],this},t.on=function(e,n){return i[e]||(i[e]=[]),i[e].push(n),this},t.init=function(){t.initUser(),t.initComments()},t.page=function(e){b(t,e)},t.generateNewCommentURL=function(){return e=o.endpoints.token,n=f(window.location.href),"".concat(e,"?redirect=").concat(encodeURI(n));var e,n},t.getHeaders=function(){var e={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return t.user&&t.user.token&&(e.Authorization="token ".concat(t.user.token)),e},y.forEach(function(e){return t[e]=e}),o.renderer){var e=c(o.renderer),n=e[0],r=e.slice(1);n.apply(void 0,[t].concat(a(r)))}return t}return y.forEach(function(e){return r[e]=e}),r.version="0.3.23",r});