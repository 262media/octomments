!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).Octomments=t()}(this,function(){"use strict";function c(n){return function(n){if(Array.isArray(n))return n}(n)||t(n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(n){return function(n){if(Array.isArray(n)){for(var t=0,e=new Array(n.length);t<n.length;t++)e[t]=n[t];return e}}(n)||t(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function t(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function u(){return!0===function(){var n="test";try{return localStorage.setItem(n,n),localStorage.removeItem(n),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function s(n,t){t=t||window.location.href,n=n.replace(/[\[\]]/g,"\\$&");var e=new RegExp("[?&]".concat(n,"(=([^&#]*)|&|#|$)")).exec(t);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function f(t){return["code","error","error_description","error_uri","t"].forEach(function(n){t=t.replace(new RegExp("[?&]".concat(n,"=[^&]+")),"")}),t}function p(n){return{id:n.id,url:n.html_url,author:{login:n.user.login,avatarUrl:n.user.avatar_url,url:n.user.html_url},body:n.body_html,createdAt:n.created_at,updatedAt:n.updated_at}}var l="ERROR",m="USER_LOADING",g="USER_NONE",d="USER_LOADED",e="COMMENTS_LOADING",w="COMMENTS_LOADED",h="COMMENT_SAVING",E="COMMENT_SAVED",v="OCTOMMENTS_USER",y=[l,e,w,h,m,g,d,E];function b(i,n){var c=i.notify,t=i.options,a=i.error,u=t.endpoints,s=t.number,f=t.github,l=!!u,m=new Error("Error getting comments for issue #".concat(s,".")),r=new Error("Issue #".concat(s," doesn't exists."));function d(n){console.error(n),a(m,2)}function h(e){return function(n,t){if(t)a(m,2);else if(n.ok)e(n);else{if(404===n.status)return a(r,1);e(n)}}}c(e),function r(n){var o=0<arguments.length&&void 0!==n?n:1,t="https://api.github.com/repos/".concat(f.owner,"/").concat(f.repo,"/issues/").concat(s,"/comments?page=").concat(o);fetch(t,{headers:i.getHeaders()}).then(h(function(n){if(!n.ok)return 401===n.status?(i.logout(!1),c(g),void r(o)):403===n.status?l?void fetch("".concat(u.issue,"?owner=").concat(f.owner,"&repo=").concat(f.repo,"&number=").concat(s)).then(h(function(n){n.ok?n.json().then(function(n){var t=n.issue.comments;i.data={comments:i.data.comments.concat(t),pagination:null},c(w,t,null)}).catch(function(n){console.error(n),a(new Error("Error parsing the API response"),3)}):a(m,2)})).catch(d):a(new Error("Rate limit exceeded."),4):a(m,2);var t=n.headers.get("Link"),e=null;t&&(e=function(n){var t=n.split(","),e={};for(var r in t){var o=t[r],i={};i.name=o.match(/rel=\"([^\"]*)/)[1],i.url=o.match(/<([^>]*)/)[1],i.page=parseInt(o.match(/page=(\d+).*$/)[1],10),e[i.name]=i}return e}(t)),n.json().then(function(n){var t=n.map(p);i.data={comments:i.data.comments.concat(t),pagination:e},c(w,t,e)}).catch(d)}))}(n)}function S(e,n){var r=e.notify,o=e.error,t=e.options,i=t.number,c=t.github,a=new Error("Adding a new comment failed.");r(h);var u,s="https://api.github.com/repos/".concat(c.owner,"/").concat(c.repo,"/issues/").concat(i,"/comments");function f(n){console.error(n),o(a,10)}fetch(s,{method:"POST",headers:e.getHeaders(),body:JSON.stringify({body:n})}).then((u=function(n){r(E,[p(n)])},function(n,t){return t?o(a,8):n.ok?void n.json().then(function(n){n?u(n):o(new Error("Parsing new-comment response failed."),10)}).catch(f):401===n.status?(e.logout(!1),r(g),o(new Error("Not authorized. Log in again."),9)):403===n.status?o(new Error("Rate limit exceeded."),4):o(a,8)})).catch(f)}function r(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.number)throw new Error("`options.number` is missing.");o.endpoints||(o.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"}),o.debug&&console.log("Octomments started with: ",JSON.stringify(o,null,2));var i={},e={user:null,data:{comments:[],pagination:null},options:o,LS:u(),error:function(n,t){e.notify(l,n,t)},notify:function(n){for(var t=arguments.length,e=new Array(1<t?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];o.debug&&console.log(n,e),i[n]&&i[n].forEach(function(n){return n.apply(void 0,e)})}};if(e.initUser=function(){return function(e){function r(){return history.replaceState({},document.title,f(location.href))}var o=e.notify,i=e.error,n=e.generateNewCommentURL(),t=e.LS.getItem(v);if(t)try{e.user=JSON.parse(t),o(d,e.user,!1)}catch(n){console.error(n),i(new Error("Corrupted data in local storage."),5)}else if(s("t")){var c=s("t");e.user={token:c},o(m),fetch("https://api.github.com/user",{headers:e.getHeaders()}).then(function(n,t){t||!n.ok?(t&&console.error(t),r(),i(new Error("Problem getting user's info."),6)):n.json().then(function(n){e.user={token:e.user.token,login:n.login,avatarUrl:n.avatar_url,url:n.html_url,name:n.name},r(),e.LS.setItem(v,JSON.stringify(e.user)),o(d,e.user,!0)}).catch(function(n){console.error(n),i(new Error("Problem parsing access token response."),7)})}).catch(function(n){console.error(n),i(new Error("Problem getting access token."),6)})}else o(g,n)}(e)},e.initComments=function(){return b(e)},e.logout=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];e.user=null,e.LS.removeItem(v),n&&location.reload()},e.add=function(n){if(!e.user)throw new Error("No user logged in.");S(e,n)},e.off=function(n){return delete i[n],this},e.on=function(n,t){return i[n]||(i[n]=[]),i[n].push(t),this},e.init=function(){e.initUser(),e.initComments()},e.page=function(n){b(e,n)},e.generateNewCommentURL=function(){return n=o.endpoints.token,t=f(window.location.href),"".concat(n,"?redirect=").concat(encodeURI(t));var n,t},e.getHeaders=function(){var n={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return e.user&&e.user.token&&(n.Authorization="token ".concat(e.user.token)),n},y.forEach(function(n){return e[n]=n}),o.renderer){var n=c(o.renderer),t=n[0],r=n.slice(1);t.apply(void 0,[e].concat(a(r)))}return e}return y.forEach(function(n){return r[n]=n}),r});