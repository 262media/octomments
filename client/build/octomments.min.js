!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).Octomments=n()}(this,function(){"use strict";function t(){return!0===function(){var t="test";try{return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function p(n){return["code","error","error_description","error_uri"].forEach(function(t){n=n.replace(new RegExp("[?&]".concat(t,"=[^&]+")),"")}),n}var n="LOADING_COMMENTS",f="COMMENTS_LOADED",o="COMMENTS_ERROR",g="USER_ERROR",O="LOADING_USER",_="NO_USER",R="USER_LOADED",c="SAVING_COMMENT",a="COMMENT_SAVED",u="COMMENT_ERROR",S="OCTOMMENTS_USER";function e(o){var t=o.options,n=t.endpoints,e=t.gotoComments,r=t.github,i=t.id;e=void 0===e||e,o.notify(O);function c(t){return o.notify(g,t,l,m)}function a(){return history.replaceState({},document.title,"".concat(p(location.href)).concat(e?"#comments":""))}var u,s,f,d,l=n?(u=n.token,s=p(window.location.href),"".concat(u,"?redirect_url=").concat(encodeURI(s))):null,m=r?(f=i,"https://github.com/".concat((d=r).owner,"/").concat(d.repo,"/issues/").concat(f,"#new_comment_field")):null,h=o.LS.getItem(S),E=function(t,n){n=n||window.location.href,t=t.replace(/[\[\]]/g,"\\$&");var o=new RegExp("[?&]".concat(t,"(=([^&#]*)|&|#|$)")).exec(n);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null}("code");if(h)try{o.user=JSON.parse(h),o.notify(R,o.user)}catch(t){console.error(t),c(t)}else E&&n?fetch("".concat(n.token,"?code=").concat(E)).then(function(t,n){n||!t.ok?(a(),c(new Error("Can't get a token"))):t.json().then(function(t){a(),o.LS.setItem(S,JSON.stringify(t)),o.notify(R,t),o.user=t}).catch(c)}).catch(c):o.notify(_,l,m)}function s(r){var t=r.options,i=t.endpoints,c=t.id,a=t.github,u=function(t){return r.notify(o,t)},s=!!i;r.notify(n),fetch("http://localhost:3000/assets/mock.v3.comments.json",{headers:{Accept:"application/vnd.github.v3.html+json"}}).then(function(t,n){if(n)u(n);else{if(!t.ok){if(404===t.status)return u(new Error("No issue at https://github.com/".concat(a.owner,"/").concat(a.repo,"/issues with number ").concat(c)));if(403===t.status){if(!s)return u(new Error("Rate limit exceeded."));fetch("".concat(i.issue,"?id=").concat(c)).then(function(t,n){n?u(n):t.ok?t.json().then(function(t){var n=t.issue.comments;r.data={comments:r.data.comments.concat(n),pagination:null},r.notify(f,r.data.comments,null,n)}).catch(u):404===t.status?u(new Error("GitHub issue doesn't exists")):u(new Error("Problem getting issue's data"))}).catch(u)}return u(new Error("Can't load comments."))}var o=t.headers.get("Link"),e=null;o&&(e=function(t){var n=t.split(","),o={};for(var e in n){var r=n[e],i={};i.name=r.match(/rel=\"([^\"]*)/)[1],i.url=r.match(/<([^>]*)/)[1],i.page=parseInt(r.match(/page=(\d+).*$/)[1],10),o[i.name]=i}return o}(o)),t.json().then(function(t){var n=t.map(function(t){return{id:t.id,url:t.html_url,author:{login:t.user.login,avatarUrl:t.user.avatar_url,url:t.user.html_url},body:t.body_html,createdAt:t.created_at,updatedAt:t.updated_at}});r.data={comments:r.data.comments.concat(n),pagination:e},r.notify(f,r.data.comments,e,n)}).catch(u)}})}function d(o,t){function e(t){return o.notify(u,t)}var n=o.options,r=n.endpoints,i=n.id;o.notify(c),fetch("".concat(r.issue),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:!0,body:t,token:o.user.token,id:i})}).then(function(t,n){return n?e(n):t.ok?void t.json().then(function(t){t.issue.comments?o.notify(a,t.issue.comments):e(new Error("Wrong data format"))}).catch(e):401===t.status?(o.logout(!1),o.notify(_),e(new Error("Not authorized. Log in again."))):e(new Error("Adding a new comment failed."))}).catch(e)}function r(r){if(!r)throw new Error("Octomments options required.");if(!r.github||!r.github.owner||!r.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!r.id)throw new Error("`options.id` is missing.");var i={},n={user:null,data:{comments:[],pagination:null},options:r,LS:t(),notify:function(t){for(var n=arguments.length,o=new Array(1<n?n-1:0),e=1;e<n;e++)o[e-1]=arguments[e];r.debug&&console.log(t),i[t]&&i[t].forEach(function(t){return t.apply(void 0,o)})},logout:function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];n.user=null,n.LS.removeItem(S),t&&location.reload()},add:function(t){if(!n.user)throw new Error("No user logged in.");d(n,t)},off:function(t){return delete i[t],this},on:function(t,n){return i[t]||(i[t]=[]),i[t].push(n),this},init:function(){e(n),s(n)},page:function(t){s(n)}};return n}return r.LOADING_COMMENTS=n,r.COMMENTS_LOADED=f,r.COMMENTS_ERROR=o,r.USER_ERROR=g,r.LOADING_USER=O,r.NO_USER=_,r.USER_LOADED=R,r.SAVING_COMMENT=c,r.COMMENT_SAVED=a,r.NEW_COMMENT_ERROR=u,r});