!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).Octomments=t()}(this,function(){"use strict";function r(n){return function(n){if(Array.isArray(n))return n}(n)||t(n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(n){return function(n){if(Array.isArray(n)){for(var t=0,e=new Array(n.length);t<n.length;t++)e[t]=n[t];return e}}(n)||t(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function t(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function a(){return!0===function(){var n="test";try{return localStorage.setItem(n,n),localStorage.removeItem(n),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function f(n,t){t=t||window.location.href,n=n.replace(/[\[\]]/g,"\\$&");var e=new RegExp("[?&]".concat(n,"(=([^&#]*)|&|#|$)")).exec(t);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function l(t){return["code","error","error_description","error_uri"].forEach(function(n){t=t.replace(new RegExp("[?&]".concat(n,"=[^&]+")),"")}),t}var u="ERROR",m="USER_LOADING",d="USER_NONE",h="USER_LOADED",e="COMMENTS_LOADING",p="COMMENTS_LOADED",g="COMMENT_SAVING",w="COMMENT_SAVED",E="OCTOMMENTS_USER",v=[u,e,p,g,m,d,h,w];function b(o){var c=o.notify,n=o.options,i=o.error,a=n.endpoints,u=n.number,r=n.github,s=!!a,f=new Error("Error getting comments for issue #".concat(u,".")),l=new Error("Issue #".concat(u," doesn't exists."));c(e),function(n){var t=0<arguments.length&&void 0!==n?n:1,e="https://api.github.com/repos/".concat(r.owner,"/").concat(r.repo,"/issues/").concat(u,"/comments?page=").concat(t);fetch(e,{headers:{Accept:"application/vnd.github.v3.html+json"}}).then(function(n,t){if(t)i(f,2);else{if(!n.ok){if(404===n.status)return i(l,1);if(403===n.status){if(!s)return i(new Error("Rate limit exceeded."),4);fetch("".concat(a.issue,"?number=").concat(u)).then(function(n,t){t?i(f,2):n.ok?n.json().then(function(n){var t=n.issue.comments;o.data={comments:o.data.comments.concat(t),pagination:null},c(p,t,null)}).catch(function(n){console.err(n),i(new Error("Error parsing the API response"),3)}):404===n.status?i(l,1):i(f,2)}).catch(function(n){console.err(n),i(f,2)})}return i(f,2)}var e=n.headers.get("Link"),r=null;e&&(r=function(n){var t=n.split(","),e={};for(var r in t){var o=t[r],c={};c.name=o.match(/rel=\"([^\"]*)/)[1],c.url=o.match(/<([^>]*)/)[1],c.page=parseInt(o.match(/page=(\d+).*$/)[1],10),e[c.name]=c}return e}(e)),n.json().then(function(n){var t=n.map(function(n){return{id:n.id,url:n.html_url,author:{login:n.user.login,avatarUrl:n.user.avatar_url,url:n.user.html_url},body:n.body_html,createdAt:n.created_at,updatedAt:n.updated_at}});o.data={comments:o.data.comments.concat(t),pagination:r},c(p,t,r)}).catch(function(n){console.err(n),i(f,2)})}})}()}function o(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.number)throw new Error("`options.number` is missing.");var c={},s={user:null,data:{comments:[],pagination:null},options:o,LS:a(),error:function(n,t){s.notify(u,n,t)},notify:function(n){for(var t=arguments.length,e=new Array(1<t?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];o.debug&&console.log(n,e),c[n]&&c[n].forEach(function(n){return n.apply(void 0,e)})}};if(s.initUser=function(){return function(e){var r=e.notify,n=e.options,o=e.error,t=n.endpoints,c=n.gotoComments;function i(){return history.replaceState({},document.title,"".concat(l(location.href)).concat(c?"#comments":""))}c=void 0===c||c,r(m);var a=e.generateNewCommentURL(),u=e.LS.getItem(E);if(u)try{e.user=JSON.parse(u),r(h,e.user)}catch(n){console.error(n),o(new Error("Corrupted data in local storage."),5)}else t&&f("code")?fetch("".concat(t.token,"?code=").concat(f("code"))).then(function(n,t){t||!n.ok?(t&&console.error(t),i(),o(new Error("Problem getting access token."),6)):n.json().then(function(n){i(),e.LS.setItem(E,JSON.stringify(n)),e.user=n,r(h,n)}).catch(function(n){console.error(n),o(new Error("Problem parsing access token response."),7)})}).catch(function(n){console.error(n),o(new Error("Problem getting access token."),6)}):r(d,a)}(s)},s.initComments=function(){return b(s)},s.logout=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];s.user=null,s.LS.removeItem(E),n&&location.reload()},s.add=function(n){if(!s.user)throw new Error("No user logged in.");var e,t,r,o,c,i,a,u;t=n,r=(e=s).notify,o=e.error,c=e.options,i=c.endpoints,a=c.number,u=new Error("Adding a new comment failed."),r(g),fetch("".concat(i.issue),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:!0,body:t,token:e.user.token,number:a})}).then(function(n,t){return t?o(u,8):n.ok?void n.json().then(function(n){n.issue.comments?r(w,n.issue.comments):o(new Error("Parsing new-comment response failed."),10)}).catch(function(n){console.error(n),o(u,10)}):401===n.status?(e.logout(!1),r(d),o(new Error("Not authorized. Log in again."),9)):o(u,8)}).catch(function(n){console.error(n),o(u,8)})},s.off=function(n){return delete c[n],this},s.on=function(n,t){return c[n]||(c[n]=[]),c[n].push(t),this},s.init=function(){s.initUser(),s.initComments()},s.page=function(n){b(s)},s.generateNewCommentURL=function(){return o.endpoints?(e=o.endpoints.token,r=l(window.location.href),"".concat(e,"?redirect_url=").concat(encodeURI(r))):o.github?(n=o.number,t=o.github,"https://github.com/".concat(t.owner,"/").concat(t.repo,"/issues/").concat(n,"#new_comment_field")):null;var n,t,e,r},v.forEach(function(n){return s[n]=n}),o.renderer){var n=r(o.renderer),t=n[0],e=n.slice(1);t.apply(void 0,[s].concat(i(e)))}return s}return v.forEach(function(n){return o[n]=n}),o});